<!DOCTYPE html>
<html>

    <head lang="en">
        <meta charset="UTF-8">
        <title>VCS Lisp</title>
        <meta name="description" content="VCS Lisp - LISP programming on the Atari 2600">
        <link rel="stylesheet" href="css/lisp.css"/>
    </head>

    <body>
        <div class="header">
            <span>VCS Lisp - Web IDE</span>
        </div>
        <div class="main">
            <div class="console">
                <div id="screen">
                    <canvas id="stellerator-canvas" tabindex=0></canvas>
                </div>
                <div id="console_controls" class="row">
                    <div class="console_switch" id="console_switch_power">Power</div>
                    <div class="console_switch" id="console_switch_color">Color/BW</div>        
                    <div class="console_switch" id="console_switch_a">Difficulty A</div>        
                    <div class="console_switch" id="console_switch_b">Difficulty B</div>        
                    <div class="console_toggle" id="console_switch_select">Select</div>        
                    <div class="console_toggle" id="console_switch_reset">Reset</div> 
                </div>
            </div>
            <div class="sidepanel">
                <div class="metaconsole">
                    <div class="row">
                        <div class="ide_ops" onclick="window.ide.saveProject(event)">SAVE</div>
                        <div class="ide_ops"> 
                            <label>LOAD</label>
                            <input type="file" style="opacity: 0" onchange="window.ide.loadProject(event)"></input>
                        </div>
                    </div>
                    <div class="row">
                        <div class="ide_ops" onclick="window.ide.changeMode(event, 0)">CALC</div>
                        <div class="ide_ops" onclick="window.ide.changeMode(event, 1)">SONG</div>
                        <div class="ide_ops" onclick="window.ide.changeMode(event, 2)">GAME</div>
                        <div class="ide_ops" onclick="window.ide.changeMode(event, 3)">STAX</div>
                        <div class="ide_ops" onclick="window.ide.eval(event)">EVAL</div>
                    </div>
                    <div class="row">
                        <div class="ide_ops" onclick="window.ide.recallMemory(event)">RCL</div>
                        <div class="ide_ops" onclick="window.ide.storeMemory(event)">STO</div>
                        <div class="ide_ops" onclick="window.ide.clearMemory(event)">CLR</div>
                    </div>

                    <div class="ide" id="ide">
                        <div class="row">
                            <div class="ide_links active"  onclick="window.ide.openWindow(event, 'repl')">REPL</div>
                            <div class="ide_links" onclick="window.ide.openWindow(event, 'f0')">&#x1D77A;</div>
                            <div class="ide_links" onclick="window.ide.openWindow(event, 'f1')">&#x1084B;</div>
                            <div class="ide_links" onclick="window.ide.openWindow(event, 'f2')">&#x1D453;</div>
                        </div>
                        <div id="repl" class="ide_content active" style="display: block" contenteditable="true" spellcheck="false"></div>
                        <div id="f0" class="ide_content" contenteditable="true" spellcheck="false"></div>
                        <div id="f1" class="ide_content" contenteditable="true" spellcheck="false"></div>        
                        <div id="f2" class="ide_content" contenteditable="true" spellcheck="false"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="ide_dialog" class="modal">
            <div class="modal-body"></div>
            <div class="modal-footer"></div>
        </div>
        <script src="js/stellerator-embedded.js"></script>
        <script src="js/lisp.js"></script>
        <script>
             (async function() {
                // Shortcut to avoid typing out the namespace
                const Stellerator = $6502.Stellerator;

                // We load the ROM file using the fetch API. We could also hardcode the ROM as a base64 encoded string
                // and pass that to stellerator instead.
                const response = await fetch("./roms/lisp_NTSC.bin");//study/keypad.bin");/
                const rom = new Uint8Array(await response.arrayBuffer());

                const keyboardTarget = document.getElementById('stellerator-canvas');

                // Create the stellerator instance
                const stellerator = new $6502.Stellerator(
                    // The canvas element
                    document.getElementById('stellerator-canvas'),
                    // The URL from which the web worker will be loaded
                    'js/stellerator.js',
                    {
                        gamma: 1,
                        scalingMode: Stellerator.ScalingMode.qis,
                        tvEmulation: Stellerator.TvEmulation.none, // disable TV emulation mode
                        keyboardTarget: keyboardTarget,
                        phosphorLevel: 0.5,
                        scanlineLevel: 0.0
                    }
                );

                // // The DOM node that displays emulation speed
                // const speedElement = document.getElementById('speed');
                // // Subscribe to speed updates and update the DOM node accordingly
                // stellerator.frequencyUpdate.addHandler(
                //     speed => speedElement.innerText = `Emulation running at ${(speed / 1000000).toFixed(2)}MHz`
                // );

                // We are using a responsive layout and resize the canvas as the window
                // size changes -> notify the video driver of the size changes.
                //
                // Note that no action needs to be taken in fullscreen mode --- the fullscreen
                // drivers takes care of window resizes itself.
                window.addEventListener('resize', () => stellerator.isFullscreen() || stellerator.resize());

                // Run the emulator in NTSC mode.
                await stellerator.run(
                    rom, 
                    Stellerator.TvMode.ntsc,
                    { 
                        controllerPort0: Stellerator.ControllerType.joystick,
                        controllerPort1: Stellerator.ControllerType.joystick
                    }
                );

                // Expose the instance for tinkering.
                window.stellerator = stellerator;

                const ide = await lispInit(stellerator);
                window.ide = ide;

            })();
        </script>

    </body>
</html>