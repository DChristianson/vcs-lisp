<!DOCTYPE html>
<html>

    <head lang="en">
        <meta charset="UTF-8">
        <title>VCS Lisp</title>
        <meta name="description" content="VCS Lisp - LISP programming on the Atari 2600">
        <link rel="stylesheet" href="css/lisp.css"/>
    </head>

    <body>
        <div class="header">
            <span>VCS Lisp - Web IDE</span>
        </div>
        <div class="main">
            <div class="console">
                <div id="screen">
                    <canvas id="stellerator-canvas" tabindex=0></canvas>
                </div>
                <div id="console_controls" class="row">
                    <div class="console_switch" id="console_switch_power"
                         onclick="window.togglePower(event)"
                    >
                        <span>On</span>
                        <span>Off</span>
                        <label>Power</label>
                    </div>        
                    <div class="console_switch" id="console_switch_color"
                         onclick="toggleSwitch(event, window.stellerator.getControlPanel().color())"
                    >
                        <span>Joystick</span>
                        <span>Keyboard</span>
                        <label>Controllers</label>
                    </div>        
                    <div class="console_switch"
                         id="console_switch_select"
                         onmousedown="window.stellerator.getControlPanel().select().toggle(true)"
                         onmouseup="window.stellerator.getControlPanel().select().toggle(false)"
                    >
                        <label>Select</label>
                    </div>        
                    <div class="console_switch"
                         id="console_switch_reset"
                         onmousedown="window.stellerator.getControlPanel().reset().toggle(true)"
                         onmouseup="window.stellerator.getControlPanel().reset().toggle(false)"
                    >
                        <label>Reset</label>
                    </div> 
                </div>
            </div>
            <div class="sidepanel">
                <div class="metaconsole">
                    <div class="ide_ops_group">
                        <label>Files</label>
                        <div class="ide_ops"> 
                            <label>LOAD</label>
                            <input type="file" onchange="window.ide.loadProject(event)"></input>
                        </div>
                        <div class="ide_ops" onclick="window.ide.saveProject(event)">SAVE</div>
                        <div class="ide_ops" onclick="window.ide.shareProject(event)">SHARE</div>
                    </div>
                    <div class="ide_ops" onclick="window.ide.saveProject(event)">HELP</div>
                    <div class="row">
                        <div class="ide_ops_group">
                            <label>Game Mode</label>
                            <div class="ide_ops" onclick="window.ide.changeMode(event, 0)">CALC</div>
                            <div class="ide_ops" onclick="window.ide.changeMode(event, 1)">SONG</div>
                            <div class="ide_ops" onclick="window.ide.changeMode(event, 2)">GAME</div>
                            <div class="ide_ops" onclick="window.ide.changeMode(event, 3)">STAX</div>
                        </div>
                        <div class="ide_ops_group">
                            <div class="ide_ops" onclick="window.ide.eval(event)">EVAL</div>
                            <div class="ide_ops" onclick="window.ide.recallMemory(event)">RCL</div>
                            <div class="ide_ops" onclick="window.ide.storeMemory(event)">STO</div>
                            <div class="ide_ops" onclick="window.ide.clearMemory(event)">CLR</div>
                        </div> 
                    </div>                                                       
                    <div class="ide" id="ide">
                        <div class="row">
                            <div class="ide_links func_repl active"  onclick="window.ide.openWindow(event, 'repl')">LISP - &#x1D77A;</div>
                            <div class="ide_links func_f" onclick="window.ide.openWindow(event, 'f')">F - &#x2A00;</div>
                            <div class="ide_links func_g" onclick="window.ide.openWindow(event, 'g')">G - &#x25BD;</div>
                            <div class="ide_links func_h" onclick="window.ide.openWindow(event, 'h')">H - &#x2734;</div>
                        </div>
                        <div id="repl" class="ide_content func_repl active" style="display: block" contenteditable="true" spellcheck="false"></div>
                        <div id="f" class="ide_content func_f" contenteditable="true" spellcheck="false"></div>
                        <div id="g" class="ide_content func_g" contenteditable="true" spellcheck="false"></div>        
                        <div id="h" class="ide_content func_h" contenteditable="true" spellcheck="false"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="ide_dialog" class="modal">
            <div class="modal-body"></div>
            <div class="modal-footer"></div>
        </div>
        <script src="js/stellerator-embedded.js"></script>
        <script src="js/lisp.js"></script>
        <script>

            function toggleSwitch(event, controlSwitch) {
                controlSwitch.toggle(!controlSwitch.read());
            };

            function registerSwitchStateHandler(targetElement, controlSwitch) {
                controlSwitch.stateChange.addHandler( state => {
                    const toggled = targetElement.className.endsWith(" toggle");
                    if (state && !toggled) {
                        targetElement.className = targetElement.className += " toggle";
                    } else if (!state && toggled) {
                        targetElement.className = targetElement.className.replace(" toggle", "");
                    }
                });
            };

             (async function() {
                // Shortcut to avoid typing out the namespace
                const Stellerator = $6502.Stellerator;

                // We load the ROM file using the fetch API. We could also hardcode the ROM as a base64 encoded string
                // and pass that to stellerator instead.
                const response = await fetch("./roms/lisp_NTSC.bin");//study/keypad.bin");/
                const rom = new Uint8Array(await response.arrayBuffer());
                const canvas = document.getElementById('stellerator-canvas');
                const keyboardTarget = canvas;
                
                // Create the stellerator instance
                const stellerator = new $6502.Stellerator(
                    // The canvas element
                    canvas,
                    // The URL from which the web worker will be loaded
                    'js/stellerator.js',
                    {
                        gamma: 1,
                        scalingMode: Stellerator.ScalingMode.qis,
                        tvEmulation: Stellerator.TvEmulation.none, // disable TV emulation mode
                        keyboardTarget: keyboardTarget,
                        phosphorLevel: 0.5,
                        scanlineLevel: 0.0
                    }
                );
            
                // // The DOM node that displays emulation speed
                // const speedElement = document.getElementById('speed');
                // // Subscribe to speed updates and update the DOM node accordingly
                // stellerator.frequencyUpdate.addHandler(
                //     speed => speedElement.innerText = `Emulation running at ${(speed / 1000000).toFixed(2)}MHz`
                // );

                // We are using a responsive layout and resize the canvas as the window
                // size changes -> notify the video driver of the size changes.
                //
                // Note that no action needs to be taken in fullscreen mode --- the fullscreen
                // drivers takes care of window resizes itself.
                window.addEventListener('resize', () => stellerator.isFullscreen() || stellerator.resize());

                // Run the emulator in NTSC mode.
                const run = async () => {
                    return stellerator.run(
                        rom, 
                        Stellerator.TvMode.ntsc,
                        { 
                            controllerPort0: Stellerator.ControllerType.joystick,
                            controllerPort1: Stellerator.ControllerType.joystick
                        }
                    );
                };
                    
                window.togglePower = function (event) {
                    if (stellerator.getState() === Stellerator.State.stopped) {
                        run();
                    } else if (stellerator.getState() === Stellerator.State.running) {
                        stellerator.stop();
                    }
                };

                await run();

                // Expose the instance for tinkering.
                window.stellerator = stellerator;

                const ide = await lispInit(stellerator);
                window.ide = ide;

                // hook up ux
                stellerator.stateChange.addHandler(
                    state => {
                        const targetElement = document.getElementById('console_switch_power');
                        const toggled = targetElement.className.endsWith(" toggle")
                        if (state === Stellerator.State.stopped && !toggled) {
                            targetElement.className = targetElement.className += " toggle";
                        } else if (state === Stellerator.State.running && toggled) {
                            targetElement.className = targetElement.className.replace(" toggle", "");
                        }
                    }
                );

                registerSwitchStateHandler(
                    document.getElementById('console_switch_color'),
                    stellerator.getControlPanel().color()
                );
                registerSwitchStateHandler(
                    document.getElementById('console_switch_select'),
                    stellerator.getControlPanel().select()
                );
                registerSwitchStateHandler(
                    document.getElementById('console_switch_reset'),
                    stellerator.getControlPanel().reset()
                );

            })();

        </script>

    </body>
</html>